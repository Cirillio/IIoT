# Лог устранения проблем и Docker Cheat Sheet

## 1. Анализ проблем и решений

В ходе развертывания проекта DipMod в Docker мы столкнулись с каскадом проблем. Ниже приведено детальное описание каждой ошибки и примененного решения.

### 1.1. Права доступа (Permission denied)
**Проблема:** Ошибка `PermissionError: [Errno 13] Permission denied` при попытке подключиться к Docker daemon.
**Причина:** Текущий пользователь системы не добавлен в группу `docker`, поэтому доступ к сокету `/var/run/docker.sock` запрещен.
**Решение (Временное):** Использование `sudo` перед каждой командой.
**Решение (Постоянное):** Выполнить команду `sudo usermod -aG docker $USER` и перезайти в систему.

### 1.2. Привилегированные порты (Modbus 502)
**Проблема:** Симулятор Modbus не запускался или требовал прав root.
**Причина:** Порты ниже 1024 (например, стандартный Modbus порт 502) являются привилегированными в Linux.
**Решение:**
*   Порт сервера симулятора изменен на **5020**.
*   В конфигурацию клиента (`appsettings.json`) и Docker Compose добавлены настройки для работы с нестандартным портом.

### 1.3. Конфликт версий библиотек (Swagger/Swashbuckle)
**Проблема:** Сервис `gateway` падал с ошибкой `System.TypeLoadException` при запуске.
**Причина:** Использовалась пре-релизная версия `Swashbuckle.AspNetCore` (7.2.0), несовместимая с текущим окружением .NET.
**Решение:** Даунгрейд пакета до стабильной версии **6.5.0** в `modbusWebGateway.csproj`.

### 1.4. Сетевая изоляция Docker (Connection refused / Name resolution)
**Проблема:** `modbus_client` не мог подключиться к симулятору (`sim`) или базе данных.
**Причина:** У сервиса `client` был включен параметр `network_mode: "host"`. В этом режиме контейнер использует сеть хоста, но теряет доступ к внутренней DNS-сети Docker (не видит сервисы по именам `db`, `sim`).
**Решение:** Удален `network_mode: "host"`. Строки подключения изменены с `127.0.0.1` на имена сервисов: `db` и `sim`.

### 1.5. Отсутствие системных зависимостей (GSSAPI/Kerberos)
**Проблема:** Клиент падал с ошибкой `Cannot load library libgssapi_krb5.so.2` при подключении к PostgreSQL.
**Причина:** Драйвер `Npgsql` пытается использовать GSSAPI для аутентификации, но в облегченном образе Debian/Alpine этих библиотек нет по умолчанию.
**Решение:** В `Dockerfile` клиента добавлена установка пакета:
```dockerfile
RUN apt-get update && apt-get install -y libgssapi-krb5-2
```

### 1.6. "Зомби" контейнеры в docker-compose (KeyError: 'ContainerConfig')
**Проблема:** `docker-compose` (старая версия на Python) выдавал ошибку при попытке пересоздать контейнеры.
**Причина:** Несовместимость метаданных контейнера, созданного новой версией Docker Engine, со старым парсером `docker-compose`.
**Решение:** Полное ручное удаление проблемных контейнеров перед запуском:
```bash
sudo docker stop <container_name> && sudo docker rm <container_name>
```

### 1.7. Логирование (Serilog Configuration)
**Проблема:** Не выводились Debug-логи, несмотря на настройки в `docker-compose`.
**Причина:** Уровень логирования был "захардкожен" в коде C# (`.MinimumLevel.Information()`), что игнорировало внешние настройки.
**Решение:**
1.  Добавлен пакет `Serilog.Settings.Configuration`.
2.  Код изменен на использование `.ReadFrom.Configuration(configuration)`.

---

## 2. Полезные команды Docker и Docker Compose

### Базовое управление (Build & Run)

*   **Пересборка и запуск в фоне:**
    ```bash
    docker-compose up -d --build
    ```
*   **Полная очистка и удаление данных:**
    ```bash
    docker-compose down -v --rmi local
    ```
*   **Остановка и удаление конкретного контейнера (ядерный вариант):**
    ```bash
    docker stop <name> && docker rm <name>
    ```

### Логирование и диагностика

*   **Следить за логами:**
    ```bash
    docker logs -f --tail 50 <name>
    ```
*   **Список всех контейнеров (включая упавшие):**
    ```bash
    docker ps -a
    ```

### Краткий справочник аргументов (Флаги)

| Флаг / Аргумент | Полное имя | Описание |
| :--- | :--- | :--- |
| **`-d`** | `--detach` | **Фоновый режим.** Запускает контейнер в "бэкграунде". Вы сразу возвращаетесь в командную строку, а контейнер живет своей жизнью. |
| **`-f`** | `--follow` | **Слежение.** Не просто выводит логи, а держит соединение открытым и дописывает новые строки по мере их появления. |
| **`--build`** | | **Принудительная сборка.** Игнорирует кэш образов и собирает их заново из Dockerfile. Обязательно, если вы правили код или зависимости. |
| **`-v`** | `--volumes` | **Удаление данных.** При команде `down` удаляет именованные тома (базы данных). Используйте осторожно — данные внутри БД сотрутся! |
| **`--rmi`** | `--remove-images` | **Удаление образов.** Очищает диск от собранных образов. Аргумент `local` удалит только те, у которых нет кастомного тега. |
| **`--tail N`** | | **Ограничение вывода.** Выводит только последние `N` строк логов. Помогает не ждать загрузки истории, если контейнер работал долго. |
| **`-i`** | `--interactive` | **Интерактивность.** Оставляет STDIN открытым, даже если не подключен терминал. |
| **`-t`** | `--tty` | **Псевдо-терминал.** Эмулирует настоящий терминал внутри контейнера (чтобы работали цвета, автодополнение и т.д.). |
| **`-it`** | | Комбинация `-i` и `-t`. Используется всегда, когда нужно "зайти" в контейнер (`docker exec -it ...`). |
| **`--rm`** | | **Авто-удаление.** Удаляет контейнер сразу после того, как он завершит работу (удобно для разовых команд). |