# Архитектура Программно-Аппаратного Комплекса IIoT (v2.1)

**Стек:** .NET 10 / PostgreSQL (TimescaleDB) / Flutter / Vue 3 (Vite) / Docker

## 1. Концепция Системы

Распределенный программно-аппаратный комплекс для мониторинга промышленных контроллеров (ADAM-6017).

**Ключевые принципы:**

1.  **Гибридное хранение:** Сочетание сырых данных (Raw) для детального анализа и агрегатов для быстрой отрисовки за год.
2.  **Разделение ролей:** Четкое разграничение прав и интерфейсов для Инженера (Web/Admin) и Оператора (Mobile/Read-only).
3.  **Безопасный доступ:** Использование Cloudflare Tunnel для доступа из интернета без открытия портов и "белого" IP (Zero Trust).

## 2. Инфраструктура (Docker Host)

Развертывание через `docker-compose`.

### Сервисы (Containers):

1.  **`db` (TimescaleDB HA):**
    *   Образ: `timescale/timescaledb:latest-pg15`.
    *   Функции: Гипертаблицы, непрерывная агрегация, фоновое сжатие (90%+ экономии места).
2.  **`client` (Modbus Collector):**
    *   .NET 10 Worker Service.
    *   Опрос железа (ADAM-6017) и первичная обработка.
3.  **`gateway` (Web API):**
    *   .NET 10 Minimal API + Embedded Frontend.
    *   Раздает статику Vue-админки и управляет SignalR потоками.
4.  **`tunnel` (Cloudflared):**
    *   Обеспечивает доступ по `https://api.domain.com`.

## 3. Компоненты Системы

### 3.1. Modbus Client (Collector Service)

*   **Масштабируемость:** Использует таблицу `devices` для получения списка IP-адресов оборудования.
*   **Offline Buffering:** При потере связи с БД кэширует данные локально в **SQLite (WAL mode)**, затем выгружает пачкой (FIFO).
*   **High Performance:** Использует **PostgreSQL Binary COPY** для сверхбыстрой вставки метрик.
*   **Deadband:** Фильтрует "шум", записывая только значимые изменения.
*   **Heartbeat:** Принудительная запись точки раз в период, если значение не меняется.

### 3.2. Storage Layer (TimescaleDB)

*   `metrics`: Гипертаблица для сырых данных (~90 дней).
*   `metrics_hourly`: Материализованное представление (Continuous Aggregate) для графиков за год.
*   `sensor_settings`: Метаданные, JSON-конфиг UI (`ui_config`), формулы виртуальных датчиков.
*   **Retention:** Процедура `prc_run_retention` удаляет старые данные раз в сутки.

### 3.3. Web API Gateway & Logic

*   **Embedded Frontend:** Раздает статические файлы Vue-админки (режим "один файл").
*   **SignalR Hub:** Транслирует живые данные и алерты.
*   **Virtual Engine:** Считает формулы (напр. КПД) на лету.
*   **Session Tracker:** Ограничивает количество одновременных подключений (макс. 10 IP) для защиты канала.

## 4. Клиентский Слой (UI)

### 4.1. Мобильный Терминал (Flutter)
**Роль:** Обходчик / Оператор.
*   **Hardware Linking:** Сканирование QR-кода на оборудовании для быстрого перехода к датчикам.
*   **Critical Alerts:** Push-уведомления и вибрация при выходе за уставки.
*   **System Health:** Мониторинг статусов сервисов.
*   **Режим "Только чтение"**: Физически не имеет интерфейсов для изменения настроек.

### 4.2. АРМ Инженера (Web / Vue 3)
**Роль:** Администратор / Технолог.
*   **Полная настройка:** Управление списком устройств (`devices`), калибровка датчиков (Zod валидация).
*   **Аналитика:** Глубокий анализ по историческим данным (ECharts).
*   **Управление данными:** Настройка сроков хранения (Retention).

## 5. Защита и Безопасность

*   **Туннелирование:** Cloudflare Tunnel шифрует трафик, внешний IP сервера скрыт.
*   **Аутентификация:** Доступ к API только по токену.
*   **Ограничение сессий:** Лимит 10 подключений для защиты от перегрузки канала.
