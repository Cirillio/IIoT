Ниже представлена итоговая сводка функциональных требований к мобильному приложению (Flutter). Этот документ можно использовать как главу **«Функциональная спецификация мобильного терминала оператора»** .

Приложение позиционируется как **«Инструмент полевого контроля» (Field Operator Tool)** . Его главная задача — обеспечить доступ к данным «в полях», оперативную реакцию на аварии и физическую идентификацию оборудования.

---

### 1. Модуль «Живая Телеметрия» (Live Monitoring)

Основной экран приложения, отображающий текущее состояние всех датчиков в режиме реального времени.

- **Механика:**
  - Приложение устанавливает постоянное WebSocket-соединение с API Gateway через **SignalR** .
  - Подписывается на событие `ReceiveMetrics`. При поступлении пакета данных обновляет состояние локальных моделей (State Management) без перезагрузки экрана.
- **Используемые данные:**
  - **Метаданные (Static):** Загружаются один раз при старте из таблицы `sensor_settings`.
    - `name`: Имя датчика (напр. "Давление в котле").
    - `unit`: Единица измерения ("Bar", "°C").
    - `ui_config` (JSONB): Цвет прогресс-бара, иконка (FontAwesome), границы спидометра.
  - **Поток (Stream):**
    - `value`: Текущее физическое значение (уже откалиброванное на бэкенде).
    - `sensor_id`: Ключ для сопоставления.

### 2. Модуль «Система Аварийных Оповещений» (Critical Alerts)

Механизм мгновенного информирования оператора о выходе параметров за допустимые границы.

- **Механика:**
  - **Локальная проверка:** При получении нового значения приложение сверяет его с границами `output_min` и `output_max`, сохраненными в кэше настроек.
  - **Триггер:** Если `value > output_max` или `value < output_min`.
  - **Реакция:**
    - Визуальная: Карточка датчика окрашивается в красный цвет, появляется иконка `Warning`.
    - Тактильная: Вибрация телефона (Haptic Feedback).
    - Уведомление: Push-уведомление (Local Notification), если приложение свернуто.
- **Используемые данные:**
  - `sensor_settings.output_min` / `output_max` — физические границы нормы.
  - `sensor_settings.ui_config` — настройки цвета для аварийного состояния.

### 3. Модуль «QR-Идентификация» (Hardware Linking)

Функция для быстрой фильтрации данных путем сканирования физической метки на оборудовании.

- **Механика:**
  - Оператор нажимает кнопку «Scan» и наводит камеру на QR-код, наклеенный на контроллер ADAM-6017 или конкретный датчик.
  - QR-код содержит уникальный идентификатор `slug` (строковый ID).
  - Приложение распознает строку, находит соответствующий датчик в списке и открывает его детальный просмотр (или фильтрует общий список, оставляя только эту группу).
- **Используемые данные:**
  - Поле `sensor_settings.slug` (Unique Identifier).

### 4. Модуль «Здоровье Инфраструктуры» (System Health)

Экран диагностики для проверки работоспособности серверной части (полезно, когда данные перестали приходить).

- **Механика:**
  - Периодический опрос (Polling) или подписка на событие `SystemAlert` через SignalR.
  - Отображение статусов ключевых сервисов: Modbus Collector, Database, Gateway.
- **Используемые данные:**
  - Таблица `system_status`:
    - `service_name`: Имя сервиса.
    - `status`: ENUM (`ONLINE`, `OFFLINE`, `DEGRADED`).
    - `last_sync`: Время последнего отклика (если > 2 мин — горит красным).
    - `last_error`: Текст ошибки для отладки.

### 5. Модуль «Виртуальные KPI» (Virtual Metrics)

Отображение вычисляемых показателей, которые не приходят с физических портов, но важны для оператора (КПД, разница давлений).

- **Механика:**
  - Бэкенд (Virtual Sensors Engine) вычисляет формулы на лету.
  - Приложение получает их как обычные метрики, но визуализирует иначе (выделенные крупные блоки).
- **Используемые данные:**
  - `sensor_settings.data_type = 'VIRTUAL'` — признак для особого отображения в UI.
  - `sensor_settings.formula` — обрабатывается на сервере, клиент получает только результат.

---

### Техническая сводка (Стек)

1. **Сетевой слой:**
   - Протокол: **SignalR (WebSockets)** через пакет `signalr_netcore`.
   - Транспорт: Защищенный туннель **Cloudflare Tunnel** (https).
2. **Безопасность:**
   - Аутентификация: JWT Bearer Token (в заголовках запросов).
   - Режим: **Read-Only** (приложение не может менять настройки калибровки, это привилегия Vue-админки).
3. **UI/UX:**
   - Стиль: Material Design 3 или Cupertino.
   - Тема: Dark Mode (оптимизация для промышленных условий).
